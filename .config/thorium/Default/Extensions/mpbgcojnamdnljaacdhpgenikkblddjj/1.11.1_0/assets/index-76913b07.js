import{o as y,s as g,g as b}from"./sendWindowMessage-46579fce.js";import{r as I}from"./respondToWindowMessage-dfa8a563.js";import{E as u,a as m}from"./ExtMessage-a2aff225.js";import{o as k}from"./overwriteImgReferer-7612e118.js";import"./onMessage-fb148085.js";class w{static inject(e){if(!e||typeof e!="object")return;const{src:n,id:a}=e;if(!n||typeof n!="string")return;const i=document.createElement("iframe");return i.id=a,i.src=n,document.body.appendChild(i),i}static remove(e){var a;if(typeof e!="string")return;const n=document.querySelector(`iframe[id="${e}"]`);return(a=n==null?void 0:n.parentElement)==null||a.removeChild(n),n||void 0}}const p={};async function E({host:t,imgUrl:e,maxWidth:n}){if(p[e])return p[e];const a=t?await k(e,t):void 0,i=await M({imgUrl:e,maxWidth:n});return a==null||a(),i&&(p[e]=i,setTimeout(()=>delete p[e],18e4)),i}function M({imgUrl:t,maxWidth:e}){return new Promise(n=>{const a=new Image;a.crossOrigin="anonymouse",a.onload=()=>{const i=document.createElement("canvas"),s=i.getContext("2d"),r=Math.max(1,a.naturalWidth/e),o=a.naturalWidth/r,c=a.naturalHeight/r;i.width=o,i.height=c,s==null||s.drawImage(a,0,0,o,c);const d=i.toDataURL("image/webp",.9).split(",").slice(-1)[0];n(d)},a.onerror=()=>{n(void 0)},a.src=t})}async function T(){const t="https://app.trackkun.com",e=w.inject({src:t,id:"tk_migration"});if(e)return await new Promise(async n=>{var r,o;const a=await y({once:!0,timeout:9e4,filter:c=>{var d,f,h;return!!((f=(d=c.origin)==null?void 0:d.startsWith)!=null&&f.call(d,t)&&((h=c.data)!=null&&h.isReady))}}),i=e==null?void 0:e.contentWindow;if(!a||!i){n(void 0),(r=e==null?void 0:e.parentElement)==null||r.removeChild(e);return}const s=await g({event:"os:app:getMigrateData",args:{},receiverWindow:i,targetOrigin:t});n(s),s&&(await new Promise(c=>setTimeout(c,200)),await g({event:"os:app:migrateDone",args:{},receiverWindow:i,targetOrigin:t})),(o=e==null?void 0:e.parentElement)==null||o.removeChild(e)})}function D(t){return new Promise(e=>{const n=b();let a=!1;const i=r=>{a||(a=!0,e(r),w.remove(n))},s=()=>i();u.once({event:"frame:os:ready",filter:r=>(r==null?void 0:r.iFrameId)===n,handler:()=>(u.once({event:"frame:os:rawPage",filter:r=>(r==null?void 0:r.iFrameId)===n,onTimeout:s,handler:r=>{var o;return i((o=r==null?void 0:r.data)==null?void 0:o.rawPage)}}),{command:t}),onTimeout:s}),w.inject({src:P(t),id:n})})}function P(t){return t.url.startsWith("about:blank")?`https://${t.site.host}/robots.txt`:t.url}const l="https://my.mangapin.com";let v=W();u.addListeners([new m("*",async t=>{if(!(t!=null&&t.event)||!(t!=null&&t.app))return;const e=await v;return e?e.isDeprecated?t.event==="popup:app:appMetadata"?{isDeprecated:!0}:void 0:await g({event:t.event,args:t.data,receiverWindow:e.window,targetOrigin:l}):void 0})],{app:!0});u.addListeners([new m("app:os:migrateFromTrackkun",()=>T()),new m("app:os:downloadImg",async t=>({base64:await E(t.data)})),new m("app:os:scrape",t=>D(t.data.command))],{external:!0});I({event:"frame:os:getIFrameId",handler(t){var n;const e=Array.from(document.getElementsByTagName("iframe")).find(a=>a.contentWindow===t.source);(n=e==null?void 0:e.contentWindow)==null||n.postMessage({resId:t.data.reqId,result:e.id},t.origin)}});async function W(){return new Promise(async t=>{var a;const e=w.inject({src:l,id:"main"}),n=await y({once:!0,timeout:9e4,filter:i=>{var o,c;if(!((c=(o=i.origin)==null?void 0:o.startsWith)==null?void 0:c.call(o,l)))return!1;const r=i.data;return!!(r!=null&&r.isTrackkunReady)||!!(r!=null&&r.isReady)||!!(r!=null&&r.isDeprecated)}});if(!n||!(e!=null&&e.contentWindow)){t(void 0),(a=e==null?void 0:e.parentElement)==null||a.removeChild(e),setTimeout(()=>{v=W()},3e4);return}t({window:e.contentWindow,isDeprecated:!!n.isDeprecated})})}
