var qt=Object.defineProperty;var Jt=(f,h,c)=>h in f?qt(f,h,{enumerable:!0,configurable:!0,writable:!0,value:c}):f[h]=c;var H=(f,h,c)=>(Jt(f,typeof h!="symbol"?h+"":h,c),c);import{E as S,a as rt}from"./ExtMessage-a2aff225.js";import{R as it}from"./ReaderConfig-79dece3b.js";class $t{constructor(h,c,p,_){H(this,"_isAdding",!1);this.type=h,this.rawPage=c,this.userPageData=p,this.onAddEntry=_}updateUserPageData(h){this.userPageData=h}openEntry(){var c;const h=(c=this.userPageData)==null?void 0:c.entryId;h&&S.send({event:"main:openEntry",data:{id:h}})}async addEntry(){if(this._isAdding)return;this._isAdding=!0;const h=await this.onAddEntry();return this._isAdding=!1,h}dispose(){throw Error("Unimplemented")}}(function(){var f=window.Document.prototype.createElement,h=window.Document.prototype.createElementNS,c=window.Document.prototype.importNode,p=window.Document.prototype.prepend,_=window.Document.prototype.append,A=window.DocumentFragment.prototype.prepend,B=window.DocumentFragment.prototype.append,O=window.Node.prototype.cloneNode,C=window.Node.prototype.appendChild,P=window.Node.prototype.insertBefore,T=window.Node.prototype.removeChild,k=window.Node.prototype.replaceChild,F=Object.getOwnPropertyDescriptor(window.Node.prototype,"textContent"),g=window.Element.prototype.attachShadow,b=Object.getOwnPropertyDescriptor(window.Element.prototype,"innerHTML"),L=window.Element.prototype.getAttribute,W=window.Element.prototype.setAttribute,U=window.Element.prototype.removeAttribute,x=window.Element.prototype.getAttributeNS,J=window.Element.prototype.setAttributeNS,lt=window.Element.prototype.removeAttributeNS,ct=window.Element.prototype.insertAdjacentElement,dt=window.Element.prototype.insertAdjacentHTML,xt=window.Element.prototype.prepend,Rt=window.Element.prototype.append,ut=window.Element.prototype.before,ht=window.Element.prototype.after,pt=window.Element.prototype.replaceWith,ft=window.Element.prototype.remove,jt=window.HTMLElement,Y=Object.getOwnPropertyDescriptor(window.HTMLElement.prototype,"innerHTML"),mt=window.HTMLElement.prototype.insertAdjacentElement,yt=window.HTMLElement.prototype.insertAdjacentHTML,wt=new Set;"annotation-xml color-profile font-face font-face-src font-face-uri font-face-format font-face-name missing-glyph".split(" ").forEach(function(t){return wt.add(t)});function vt(t){var e=wt.has(t);return t=/^[a-z][.0-9_a-z]*-[-.0-9_a-z]*$/.test(t),!e&&t}var Ht=document.contains?document.contains.bind(document):document.documentElement.contains.bind(document.documentElement);function w(t){var e=t.isConnected;if(e!==void 0)return e;if(Ht(t))return!0;for(;t&&!(t.__CE_isImportDocument||t instanceof Document);)t=t.parentNode||(window.ShadowRoot&&t instanceof ShadowRoot?t.host:void 0);return!(!t||!(t.__CE_isImportDocument||t instanceof Document))}function Z(t){var e=t.children;if(e)return Array.prototype.slice.call(e);for(e=[],t=t.firstChild;t;t=t.nextSibling)t.nodeType===Node.ELEMENT_NODE&&e.push(t);return e}function tt(t,e){for(;e&&e!==t&&!e.nextSibling;)e=e.parentNode;return e&&e!==t?e.nextSibling:null}function et(t,e,n){for(var i=t;i;){if(i.nodeType===Node.ELEMENT_NODE){var o=i;e(o);var r=o.localName;if(r==="link"&&o.getAttribute("rel")==="import"){if(i=o.import,n===void 0&&(n=new Set),i instanceof Node&&!n.has(i))for(n.add(i),i=i.firstChild;i;i=i.nextSibling)et(i,e,n);i=tt(t,o);continue}else if(r==="template"){i=tt(t,o);continue}if(o=o.__CE_shadowRoot)for(o=o.firstChild;o;o=o.nextSibling)et(o,e,n)}i=i.firstChild?i.firstChild:tt(t,i)}}function V(){var t=!(j==null||!j.noDocumentConstructionObserver),e=!(j==null||!j.shadyDomFastWalk);this.m=[],this.g=[],this.j=!1,this.shadyDomFastWalk=e,this.I=!t}function $(t,e,n,i){var o=window.ShadyDOM;if(t.shadyDomFastWalk&&o&&o.inUse){if(e.nodeType===Node.ELEMENT_NODE&&n(e),e.querySelectorAll)for(t=o.nativeMethods.querySelectorAll.call(e,"*"),e=0;e<t.length;e++)n(t[e])}else et(e,n,i)}function It(t,e){t.j=!0,t.m.push(e)}function kt(t,e){t.j=!0,t.g.push(e)}function nt(t,e){t.j&&$(t,e,function(n){return z(t,n)})}function z(t,e){if(t.j&&!e.__CE_patched){e.__CE_patched=!0;for(var n=0;n<t.m.length;n++)t.m[n](e);for(n=0;n<t.g.length;n++)t.g[n](e)}}function R(t,e){var n=[];for($(t,e,function(o){return n.push(o)}),e=0;e<n.length;e++){var i=n[e];i.__CE_state===1?t.connectedCallback(i):X(t,i)}}function M(t,e){var n=[];for($(t,e,function(o){return n.push(o)}),e=0;e<n.length;e++){var i=n[e];i.__CE_state===1&&t.disconnectedCallback(i)}}function I(t,e,n){n=n===void 0?{}:n;var i=n.J,o=n.upgrade||function(s){return X(t,s)},r=[];for($(t,e,function(s){if(t.j&&z(t,s),s.localName==="link"&&s.getAttribute("rel")==="import"){var a=s.import;a instanceof Node&&(a.__CE_isImportDocument=!0,a.__CE_registry=document.__CE_registry),a&&a.readyState==="complete"?a.__CE_documentLoadHandled=!0:s.addEventListener("load",function(){var l=s.import;if(!l.__CE_documentLoadHandled){l.__CE_documentLoadHandled=!0;var u=new Set;i&&(i.forEach(function(m){return u.add(m)}),u.delete(l)),I(t,l,{J:u,upgrade:o})}})}else r.push(s)},i),e=0;e<r.length;e++)o(r[e])}function X(t,e){try{var n=e.ownerDocument,i=n.__CE_registry,o=i&&(n.defaultView||n.__CE_isImportDocument)?K(i,e.localName):void 0;if(o&&e.__CE_state===void 0){o.constructionStack.push(e);try{try{if(new o.constructorFunction!==e)throw Error("The custom element constructor did not produce the element being upgraded.")}finally{o.constructionStack.pop()}}catch(l){throw e.__CE_state=2,l}if(e.__CE_state=1,e.__CE_definition=o,o.attributeChangedCallback&&e.hasAttributes()){var r=o.observedAttributes;for(o=0;o<r.length;o++){var s=r[o],a=e.getAttribute(s);a!==null&&t.attributeChangedCallback(e,s,null,a,null)}}w(e)&&t.connectedCallback(e)}}catch(l){G(l)}}V.prototype.connectedCallback=function(t){var e=t.__CE_definition;if(e.connectedCallback)try{e.connectedCallback.call(t)}catch(n){G(n)}},V.prototype.disconnectedCallback=function(t){var e=t.__CE_definition;if(e.disconnectedCallback)try{e.disconnectedCallback.call(t)}catch(n){G(n)}},V.prototype.attributeChangedCallback=function(t,e,n,i,o){var r=t.__CE_definition;if(r.attributeChangedCallback&&-1<r.observedAttributes.indexOf(e))try{r.attributeChangedCallback.call(t,e,n,i,o)}catch(s){G(s)}};function gt(t,e,n,i){var o=e.__CE_registry;if(o&&(i===null||i==="http://www.w3.org/1999/xhtml")&&(o=K(o,n)))try{var r=new o.constructorFunction;if(r.__CE_state===void 0||r.__CE_definition===void 0)throw Error("Failed to construct '"+n+"': The returned value was not constructed with the HTMLElement constructor.");if(r.namespaceURI!=="http://www.w3.org/1999/xhtml")throw Error("Failed to construct '"+n+"': The constructed element's namespace must be the HTML namespace.");if(r.hasAttributes())throw Error("Failed to construct '"+n+"': The constructed element must not have any attributes.");if(r.firstChild!==null)throw Error("Failed to construct '"+n+"': The constructed element must not have any children.");if(r.parentNode!==null)throw Error("Failed to construct '"+n+"': The constructed element must not have a parent node.");if(r.ownerDocument!==e)throw Error("Failed to construct '"+n+"': The constructed element's owner document is incorrect.");if(r.localName!==n)throw Error("Failed to construct '"+n+"': The constructed element's local name is incorrect.");return r}catch(s){return G(s),e=i===null?f.call(e,n):h.call(e,i,n),Object.setPrototypeOf(e,HTMLUnknownElement.prototype),e.__CE_state=2,e.__CE_definition=void 0,z(t,e),e}return e=i===null?f.call(e,n):h.call(e,i,n),z(t,e),e}function G(t){var e="",n="",i=0,o=0;t instanceof Error?(e=t.message,n=t.sourceURL||t.fileName||"",i=t.line||t.lineNumber||0,o=t.column||t.columnNumber||0):e="Uncaught "+String(t);var r=void 0;ErrorEvent.prototype.initErrorEvent===void 0?r=new ErrorEvent("error",{cancelable:!0,message:e,filename:n,lineno:i,colno:o,error:t}):(r=document.createEvent("ErrorEvent"),r.initErrorEvent("error",!1,!0,e,n,i),r.preventDefault=function(){Object.defineProperty(this,"defaultPrevented",{configurable:!0,get:function(){return!0}})}),r.error===void 0&&Object.defineProperty(r,"error",{configurable:!0,enumerable:!0,get:function(){return t}}),window.dispatchEvent(r),r.defaultPrevented||console.error(t)}function Et(){var t=this;this.g=void 0,this.F=new Promise(function(e){t.l=e})}Et.prototype.resolve=function(t){if(this.g)throw Error("Already resolved.");this.g=t,this.l(t)};function _t(t){var e=document;this.l=void 0,this.h=t,this.g=e,I(this.h,this.g),this.g.readyState==="loading"&&(this.l=new MutationObserver(this.G.bind(this)),this.l.observe(this.g,{childList:!0,subtree:!0}))}function Ct(t){t.l&&t.l.disconnect()}_t.prototype.G=function(t){var e=this.g.readyState;for(e!=="interactive"&&e!=="complete"||Ct(this),e=0;e<t.length;e++)for(var n=t[e].addedNodes,i=0;i<n.length;i++)I(this.h,n[i])};function E(t){this.s=new Map,this.u=new Map,this.C=new Map,this.A=!1,this.B=new Map,this.o=function(e){return e()},this.i=!1,this.v=[],this.h=t,this.D=t.I?new _t(t):void 0}E.prototype.H=function(t,e){var n=this;if(!(e instanceof Function))throw new TypeError("Custom element constructor getters must be functions.");bt(this,t),this.s.set(t,e),this.v.push(t),this.i||(this.i=!0,this.o(function(){return Tt(n)}))},E.prototype.define=function(t,e){var n=this;if(!(e instanceof Function))throw new TypeError("Custom element constructors must be functions.");bt(this,t),Dt(this,t,e),this.v.push(t),this.i||(this.i=!0,this.o(function(){return Tt(n)}))};function bt(t,e){if(!vt(e))throw new SyntaxError("The element name '"+e+"' is not valid.");if(K(t,e))throw Error("A custom element with name '"+(e+"' has already been defined."));if(t.A)throw Error("A custom element is already being defined.")}function Dt(t,e,n){t.A=!0;var i;try{var o=n.prototype;if(!(o instanceof Object))throw new TypeError("The custom element constructor's prototype is not an object.");var r=function(m){var q=o[m];if(q!==void 0&&!(q instanceof Function))throw Error("The '"+m+"' callback must be a function.");return q},s=r("connectedCallback"),a=r("disconnectedCallback"),l=r("adoptedCallback"),u=(i=r("attributeChangedCallback"))&&n.observedAttributes||[]}catch(m){throw m}finally{t.A=!1}return n={localName:e,constructorFunction:n,connectedCallback:s,disconnectedCallback:a,adoptedCallback:l,attributeChangedCallback:i,observedAttributes:u,constructionStack:[]},t.u.set(e,n),t.C.set(n.constructorFunction,n),n}E.prototype.upgrade=function(t){I(this.h,t)};function Tt(t){if(t.i!==!1){t.i=!1;for(var e=[],n=t.v,i=new Map,o=0;o<n.length;o++)i.set(n[o],[]);for(I(t.h,document,{upgrade:function(l){if(l.__CE_state===void 0){var u=l.localName,m=i.get(u);m?m.push(l):t.u.has(u)&&e.push(l)}}}),o=0;o<e.length;o++)X(t.h,e[o]);for(o=0;o<n.length;o++){for(var r=n[o],s=i.get(r),a=0;a<s.length;a++)X(t.h,s[a]);(r=t.B.get(r))&&r.resolve(void 0)}n.length=0}}E.prototype.get=function(t){if(t=K(this,t))return t.constructorFunction},E.prototype.whenDefined=function(t){if(!vt(t))return Promise.reject(new SyntaxError("'"+t+"' is not a valid custom element name."));var e=this.B.get(t);if(e)return e.F;e=new Et,this.B.set(t,e);var n=this.u.has(t)||this.s.has(t);return t=this.v.indexOf(t)===-1,n&&t&&e.resolve(void 0),e.F},E.prototype.polyfillWrapFlushCallback=function(t){this.D&&Ct(this.D);var e=this.o;this.o=function(n){return t(function(){return e(n)})}};function K(t,e){var n=t.u.get(e);if(n)return n;if(n=t.s.get(e)){t.s.delete(e);try{return Dt(t,e,n())}catch(i){G(i)}}}E.prototype.define=E.prototype.define,E.prototype.upgrade=E.prototype.upgrade,E.prototype.get=E.prototype.get,E.prototype.whenDefined=E.prototype.whenDefined,E.prototype.polyfillDefineLazy=E.prototype.H,E.prototype.polyfillWrapFlushCallback=E.prototype.polyfillWrapFlushCallback;function ot(t,e,n){function i(o){return function(r){for(var s=[],a=0;a<arguments.length;++a)s[a]=arguments[a];a=[];for(var l=[],u=0;u<s.length;u++){var m=s[u];if(m instanceof Element&&w(m)&&l.push(m),m instanceof DocumentFragment)for(m=m.firstChild;m;m=m.nextSibling)a.push(m);else a.push(m)}for(o.apply(this,s),s=0;s<l.length;s++)M(t,l[s]);if(w(this))for(s=0;s<a.length;s++)l=a[s],l instanceof Element&&R(t,l)}}n.prepend!==void 0&&(e.prepend=i(n.prepend)),n.append!==void 0&&(e.append=i(n.append))}function Ut(t){Document.prototype.createElement=function(e){return gt(t,this,e,null)},Document.prototype.importNode=function(e,n){return e=c.call(this,e,!!n),this.__CE_registry?I(t,e):nt(t,e),e},Document.prototype.createElementNS=function(e,n){return gt(t,this,n,e)},ot(t,Document.prototype,{prepend:p,append:_})}function Bt(t){function e(i){return function(o){for(var r=[],s=0;s<arguments.length;++s)r[s]=arguments[s];s=[];for(var a=[],l=0;l<r.length;l++){var u=r[l];if(u instanceof Element&&w(u)&&a.push(u),u instanceof DocumentFragment)for(u=u.firstChild;u;u=u.nextSibling)s.push(u);else s.push(u)}for(i.apply(this,r),r=0;r<a.length;r++)M(t,a[r]);if(w(this))for(r=0;r<s.length;r++)a=s[r],a instanceof Element&&R(t,a)}}var n=Element.prototype;ut!==void 0&&(n.before=e(ut)),ht!==void 0&&(n.after=e(ht)),pt!==void 0&&(n.replaceWith=function(i){for(var o=[],r=0;r<arguments.length;++r)o[r]=arguments[r];r=[];for(var s=[],a=0;a<o.length;a++){var l=o[a];if(l instanceof Element&&w(l)&&s.push(l),l instanceof DocumentFragment)for(l=l.firstChild;l;l=l.nextSibling)r.push(l);else r.push(l)}for(a=w(this),pt.apply(this,o),o=0;o<s.length;o++)M(t,s[o]);if(a)for(M(t,this),o=0;o<r.length;o++)s=r[o],s instanceof Element&&R(t,s)}),ft!==void 0&&(n.remove=function(){var i=w(this);ft.call(this),i&&M(t,this)})}function Wt(t){function e(o,r){Object.defineProperty(o,"innerHTML",{enumerable:r.enumerable,configurable:!0,get:r.get,set:function(s){var a=this,l=void 0;if(w(this)&&(l=[],$(t,this,function(q){q!==a&&l.push(q)})),r.set.call(this,s),l)for(var u=0;u<l.length;u++){var m=l[u];m.__CE_state===1&&t.disconnectedCallback(m)}return this.ownerDocument.__CE_registry?I(t,this):nt(t,this),s}})}function n(o,r){o.insertAdjacentElement=function(s,a){var l=w(a);return s=r.call(this,s,a),l&&M(t,a),w(s)&&R(t,a),s}}function i(o,r){function s(a,l){for(var u=[];a!==l;a=a.nextSibling)u.push(a);for(l=0;l<u.length;l++)I(t,u[l])}o.insertAdjacentHTML=function(a,l){if(a=a.toLowerCase(),a==="beforebegin"){var u=this.previousSibling;r.call(this,a,l),s(u||this.parentNode.firstChild,this)}else if(a==="afterbegin")u=this.firstChild,r.call(this,a,l),s(this.firstChild,u);else if(a==="beforeend")u=this.lastChild,r.call(this,a,l),s(u||this.firstChild,null);else if(a==="afterend")u=this.nextSibling,r.call(this,a,l),s(this.nextSibling,u);else throw new SyntaxError("The value provided ("+String(a)+") is not one of 'beforebegin', 'afterbegin', 'beforeend', or 'afterend'.")}}g&&(Element.prototype.attachShadow=function(o){if(o=g.call(this,o),t.j&&!o.__CE_patched){o.__CE_patched=!0;for(var r=0;r<t.m.length;r++)t.m[r](o)}return this.__CE_shadowRoot=o}),b&&b.get?e(Element.prototype,b):Y&&Y.get?e(HTMLElement.prototype,Y):kt(t,function(o){e(o,{enumerable:!0,configurable:!0,get:function(){return O.call(this,!0).innerHTML},set:function(r){var s=this.localName==="template",a=s?this.content:this,l=h.call(document,this.namespaceURI,this.localName);for(l.innerHTML=r;0<a.childNodes.length;)T.call(a,a.childNodes[0]);for(r=s?l.content:l;0<r.childNodes.length;)C.call(a,r.childNodes[0])}})}),Element.prototype.setAttribute=function(o,r){if(this.__CE_state!==1)return W.call(this,o,r);var s=L.call(this,o);W.call(this,o,r),r=L.call(this,o),t.attributeChangedCallback(this,o,s,r,null)},Element.prototype.setAttributeNS=function(o,r,s){if(this.__CE_state!==1)return J.call(this,o,r,s);var a=x.call(this,o,r);J.call(this,o,r,s),s=x.call(this,o,r),t.attributeChangedCallback(this,r,a,s,o)},Element.prototype.removeAttribute=function(o){if(this.__CE_state!==1)return U.call(this,o);var r=L.call(this,o);U.call(this,o),r!==null&&t.attributeChangedCallback(this,o,r,null,null)},Element.prototype.removeAttributeNS=function(o,r){if(this.__CE_state!==1)return lt.call(this,o,r);var s=x.call(this,o,r);lt.call(this,o,r);var a=x.call(this,o,r);s!==a&&t.attributeChangedCallback(this,r,s,a,o)},mt?n(HTMLElement.prototype,mt):ct&&n(Element.prototype,ct),yt?i(HTMLElement.prototype,yt):dt&&i(Element.prototype,dt),ot(t,Element.prototype,{prepend:xt,append:Rt}),Bt(t)}var Nt={};function zt(t){function e(){var n=this.constructor,i=document.__CE_registry.C.get(n);if(!i)throw Error("Failed to construct a custom element: The constructor was not registered with `customElements`.");var o=i.constructionStack;if(o.length===0)return o=f.call(document,i.localName),Object.setPrototypeOf(o,n.prototype),o.__CE_state=1,o.__CE_definition=i,z(t,o),o;var r=o.length-1,s=o[r];if(s===Nt)throw Error("Failed to construct '"+i.localName+"': This element was already constructed.");return o[r]=Nt,Object.setPrototypeOf(s,n.prototype),z(t,s),s}e.prototype=jt.prototype,Object.defineProperty(HTMLElement.prototype,"constructor",{writable:!0,configurable:!0,enumerable:!1,value:e}),window.HTMLElement=e}function Gt(t){function e(n,i){Object.defineProperty(n,"textContent",{enumerable:i.enumerable,configurable:!0,get:i.get,set:function(o){if(this.nodeType===Node.TEXT_NODE)i.set.call(this,o);else{var r=void 0;if(this.firstChild){var s=this.childNodes,a=s.length;if(0<a&&w(this)){r=Array(a);for(var l=0;l<a;l++)r[l]=s[l]}}if(i.set.call(this,o),r)for(o=0;o<r.length;o++)M(t,r[o])}}})}Node.prototype.insertBefore=function(n,i){if(n instanceof DocumentFragment){var o=Z(n);if(n=P.call(this,n,i),w(this))for(i=0;i<o.length;i++)R(t,o[i]);return n}return o=n instanceof Element&&w(n),i=P.call(this,n,i),o&&M(t,n),w(this)&&R(t,n),i},Node.prototype.appendChild=function(n){if(n instanceof DocumentFragment){var i=Z(n);if(n=C.call(this,n),w(this))for(var o=0;o<i.length;o++)R(t,i[o]);return n}return i=n instanceof Element&&w(n),o=C.call(this,n),i&&M(t,n),w(this)&&R(t,n),o},Node.prototype.cloneNode=function(n){return n=O.call(this,!!n),this.ownerDocument.__CE_registry?I(t,n):nt(t,n),n},Node.prototype.removeChild=function(n){var i=n instanceof Element&&w(n),o=T.call(this,n);return i&&M(t,n),o},Node.prototype.replaceChild=function(n,i){if(n instanceof DocumentFragment){var o=Z(n);if(n=k.call(this,n,i),w(this))for(M(t,i),i=0;i<o.length;i++)R(t,o[i]);return n}o=n instanceof Element&&w(n);var r=k.call(this,n,i),s=w(this);return s&&M(t,i),o&&M(t,n),s&&R(t,n),r},F&&F.get?e(Node.prototype,F):It(t,function(n){e(n,{enumerable:!0,configurable:!0,get:function(){for(var i=[],o=this.firstChild;o;o=o.nextSibling)o.nodeType!==Node.COMMENT_NODE&&i.push(o.textContent);return i.join("")},set:function(i){for(;this.firstChild;)T.call(this,this.firstChild);i!=null&&i!==""&&C.call(this,document.createTextNode(i))}})})}var j=window.customElements;function St(){var t=new V;zt(t),Ut(t),ot(t,DocumentFragment.prototype,{prepend:A,append:B}),Gt(t),Wt(t),window.CustomElementRegistry=E,t=new E(t),document.__CE_registry=t,Object.defineProperty(window,"customElements",{configurable:!0,enumerable:!0,value:t})}j&&!j.forcePolyfill&&typeof j.define=="function"&&typeof j.get=="function"||St(),window.__CE_installPolyfill=St}).call(self);let N;async function Vt(){return N||(N=new Xt),N.isReaderMode?N.hide():N.show(),N}class Pt extends $t{constructor(){super(...arguments);H(this,"readerController")}get isReaderMode(){return!!this.readerController}show(){throw Error("Unimplemented")}hide(){var c;(c=this.readerController)==null||c.dispose(),this.readerController=void 0}dispose(){this.hide(),N=void 0}}class Xt extends Pt{constructor(){super("lite_reader",void 0,void 0,async()=>{})}async show(){const{default:h}=await import("./index-380b924b.js");it.get(location.hostname).then(async({autoPlay:c,readerStyle:p,direction:_})=>{this.readerController=await h({isAutoShow:!1,autoPlay:c,readerStyle:p,direction:_,onDispose:()=>{this.readerController=void 0}}),this.readerController||st()})}}class Lt extends Pt{constructor({rawPage:c,readerSpec:p,siteMeta:_,onGetHiddenChapters:A,userPageData:B,initialPage:O,onAddEntry:C}){super("reader",c,B,C);H(this,"readerSpec");H(this,"siteMeta");H(this,"skipTour",!1);H(this,"onGetHiddenChapters");H(this,"readerControllerPromise");H(this,"page");H(this,"isFinished",!1);const P=!!(N!=null&&N.isReaderMode);N==null||N.dispose(),N=this,this.readerSpec=p,this.siteMeta=_,this.page=0,this.onGetHiddenChapters=A;const T=c.data;it.get(location.hostname).then(({autoShow:k,autoPlay:F,siteAutoShow:g,readerStyle:b,direction:L})=>{var x;this.page=O??0;const U=!!((x=T.imgs)!=null&&x.length||p!=null&&p.content)&&(P||(g??k));this.isFinished=!U,U?this.show({autoPlay:F,isAutoShow:!0,readerStyle:b,direction:L}):(T.next||T.title.chapters.length||!T.title.hasMoreChapters)&&this._saveProgress()})}async updateUserPageData(c){var p;super.updateUserPageData(c),await this.readerControllerPromise,c===this.userPageData&&((p=this.readerController)==null||p.updateArgs({entryId:c==null?void 0:c.entryId}))}async updateRaw(c){var p;this.rawPage.data=c,await this.readerControllerPromise,this.rawPage.data===c&&((p=this.readerController)==null||p.updateArgs({raw:c}),!this.readerController&&this.isFinished&&this._saveProgress())}async show(c){const{autoPlay:p,isAutoShow:_,readerStyle:A,direction:B}=c??await it.get().then(({autoPlay:F,readerStyle:g,direction:b})=>({autoPlay:F,isAutoShow:!1,readerStyle:g,direction:b}));this.hide();const O=()=>!this.isFinished&&this._saveProgress(!0);window.addEventListener("beforeunload",O);const C=await S.send({app:!0,event:"reader:app:userState"});let P=!1;const T=Date.now(),{default:k}=await import("./index-380b924b.js");this.readerControllerPromise=new Promise(async F=>{var g;this.readerController=await k({raw:this.rawPage.data,spec:this.readerSpec,siteMeta:this.siteMeta,page:this.page,autoPlay:p,readerStyle:A,direction:B,entryId:(g=this.userPageData)==null?void 0:g.entryId,isAutoShow:_,tourEnabled:!(C!=null&&C.hasEntries)&&await this._getIsTourEnabled(),onGetHiddenChapters:()=>this.onGetHiddenChapters(),onOpenEntry:()=>this.openEntry(),onAddEntry:()=>this.addEntry(),onPageChanged:b=>{var L;this.page>=b||(this.page=b,!((L=this.userPageData)!=null&&L.entryId)&&!P&&b>=2&&!this.isFinished&&Date.now()-T>2e3&&(P=!0,this._saveProgress(!0)))},onFinished:()=>{this.isFinished||(this.isFinished=!0,this._saveProgress())},onDispose:()=>{this.isFinished=!0,this._saveProgress(),this.page=0,this.isFinished=!1,this.readerController=void 0,this.readerControllerPromise=void 0,window.removeEventListener("beforeunload",O)},onError:()=>{_||st()}}),F()}),await this.readerControllerPromise,!this.readerController&&!_&&st()}async _getIsTourEnabled(){const c="reader:tour";return this.skipTour=this.skipTour||(await chrome.storage.local.get(c))[c],this.skipTour?!1:(chrome.storage.local.set({[c]:!0}),!0)}_saveProgress(c){var p;this.readerController&&!this.isFinished&&(!c||this.page<1)||S.send({app:!0,event:"reader:app:save",data:{rawReaderPage:this.rawPage,page:this.page,isFinished:this.isFinished,entryId:(p=this.userPageData)==null?void 0:p.entryId,host:location.host}})}}async function st(){const{showAlertDialog:f}=await import("./overlay-358edb0d.js");f("Unable to enter reader mode")}const Ot=Object.freeze(Object.defineProperty({__proto__:null,ReaderPageController:Lt,toggleReader:Vt},Symbol.toStringTag,{value:"Module"}));let y,d,D,v,Q,At=0;S.addListeners([new rt("popup:content:state",()=>({rawPage:d,isReaderMode:!!(v!=null&&v.isReaderMode),entryId:D==null?void 0:D.entryId})),new rt("popup:content:addEntry",at),new rt("popup:content:toggleReader",async()=>{if(!v&&Q||(d==null?void 0:d.type)==="title"||(v==null?void 0:v.type)==="title")return;const{toggleReader:f}=await Promise.resolve().then(()=>Ot);v=await f()})]);window.addEventListener("focus",async()=>{if(!(d!=null&&d.data)||!y)return;const f=await S.send({app:!0,event:"content:app:getUserPageData",data:{rawPage:d}});D=f,v==null||v.updateUserPageData(f)});async function Kt(){var F;if(d)return Ft;const f=Date.now();Q=f;const h=()=>{Q===f&&(Q=void 0)},c=await S.send({event:"content:main:getWebCommand",data:{url:location.origin+location.pathname}}),[p,_]=await Promise.all([c??S.send({app:!0,event:"content:app:getInput",data:{host:location.hostname}}),S.send({app:!0,event:"content:app:getConfigs"})]);if(!_){h();return}y=p==null?void 0:p.site;const{specs:A,tags:B}=_,O=location.pathname.endsWith("/")?location.pathname:`${location.pathname}/`,C=y?A.find(g=>g.id===y.specId):void 0,P={siteId:y==null?void 0:y.id,spec:C,genericSpecs:y?void 0:A.filter(g=>g.generic),siteMeta:y==null?void 0:y.meta,tags:B},{scrape:T}=await import("./scrape-46237ed9.js"),k=await T({...P,context:{disableLazyChapters:!0}});if(O!==location.pathname&&O!==location.pathname+"/"){h();return}if(d=k,!(d!=null&&d.data)){if(d!=null&&d.is404&&p&&(p.entryId||p.titleName||p.chapter))Qt(p);else if(y&&(c!=null&&c.entryId||c!=null&&c.chapter)){const g=c.chapter?"chapters":c.entryId?"title":void 0;g&&S.send({app:!0,event:"content:app:browse_failed",data:{siteId:y.id,pageType:g}})}h();return}switch(D=await S.send({app:!0,event:"content:app:getUserPageData",data:{rawPage:d}}),d.type){case"title":{if(y||D!=null&&D.progressText){const{TitlePageController:g}=await import("./title-46fe8f64.js");v=new g({site:y,rawTitleData:d.data,userPageData:D,onAddEntry:at})}break}case"reader":{const{ReaderPageController:g}=await Promise.resolve().then(()=>Ot),b=new g({rawPage:d,userPageData:D,onAddEntry:at,initialPage:p==null?void 0:p.page,readerSpec:d.spec.reader??(C==null?void 0:C.reader),siteMeta:((F=d.data)==null?void 0:F.siteMeta)??(y==null?void 0:y.meta)??d.spec.meta,onGetHiddenChapters:()=>{var L,W,U,x,J;d&&d.type==="reader"&&!((U=(W=(L=d.data)==null?void 0:L.title)==null?void 0:W.chapters)!=null&&U.length)&&((J=(x=d.spec.reader)==null?void 0:x.chapter)!=null&&J.trigger)&&Mt(b,T({...P,context:{includeHiddenChapters:!0}}))}});v=b,d.data.title.hasMoreChapters&&Mt(b,T(P));break}}return setTimeout(h,100),Ft}async function Mt(f,h){const c=await h;f!==v||!(c!=null&&c.data)||c.type!=="reader"||(d=c,f.updateRaw(c.data),!D&&(D=await S.send({app:!0,event:"content:app:getUserPageData",data:{rawPage:d}}),f===v&&D&&f.updateUserPageData(D)))}async function Qt(f){if(!f.site)return;const h=S.send({app:!0,event:"content:app:fix404",data:f}),{showAlertDialog:c,showLoadingOverlay:p}=await import("./overlay-358edb0d.js"),_=p(),A=await h;_(),A!=null&&A.url?window.location.href=A.url:c("The url might have been changed or deleted")}async function at(){const f=Date.now();if(!(f-At<1e3)){if(At=f,!(d!=null&&d.data)||!(y!=null&&y.id)){const{showAlertDialog:h}=await import("./overlay-358edb0d.js");h("Adding entry from this site is currently not supported."),d!=null&&d.data&&S.send({event:"content:app:newSiteRequest",data:{host:location.hostname}});return}await S.send({event:"main:addEntry",data:{rawPage:d,siteId:y.id,page:v instanceof Lt&&!v.isFinished?v.page:void 0}})}}function Ft(){return d!=null&&d.data&&(d==null?void 0:d.type)==="reader"&&location.pathname.includes(`/${d.data.slug}/`)?!1:(y=void 0,d=void 0,D=void 0,v==null||v.dispose(),v=void 0,!0)}const ee=Object.freeze(Object.defineProperty({__proto__:null,handleMainFrame:Kt},Symbol.toStringTag,{value:"Module"}));export{$t as B,ee as m};
